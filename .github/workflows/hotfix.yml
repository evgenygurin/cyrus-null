name: Hotfix Management

on:
  push:
    branches:
      - 'hotfix/**'
  pull_request:
    branches:
      - stage
      - prod
    types: [opened, synchronize, reopened]

jobs:
  # Check if this is actually a hotfix branch before running any jobs
  check-hotfix-branch:
    runs-on: ubuntu-latest
    # Only run if push is to hotfix branch or PR has hotfix head
    if: startsWith(github.ref, 'refs/heads/hotfix/') || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'hotfix/'))
    outputs:
      is-hotfix: ${{ steps.check.outputs.is-hotfix }}
    steps:
      - name: Check if branch is hotfix
        id: check
        run: |
          echo "is-hotfix=true" >> $GITHUB_OUTPUT
          echo "âœ… This is a hotfix branch"

  # Validate hotfix branch naming and structure
  validate-hotfix:
    runs-on: ubuntu-latest
    needs: check-hotfix-branch
    if: needs.check-hotfix-branch.result == 'success' && needs.check-hotfix-branch.outputs.is-hotfix == 'true'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Validate hotfix branch name
      run: |
        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
        echo "Validating hotfix branch: $BRANCH_NAME"
        
        # Check if branch follows hotfix/description or hotfix/ticket-number pattern
        if [[ ! "$BRANCH_NAME" =~ ^hotfix\/[a-zA-Z0-9._-]+$ ]]; then
          echo "âŒ Invalid hotfix branch name: $BRANCH_NAME"
          echo "Hotfix branches must follow the pattern: hotfix/description or hotfix/TICKET-123"
          exit 1
        fi
        
        echo "âœ… Valid hotfix branch name: $BRANCH_NAME"
    
    - name: Check hotfix base
      run: |
        # Hotfixes should typically branch from prod or stage
        git log --oneline --graph --decorate -10
        echo "âœ… Hotfix branch structure validated"

  # Test hotfix changes
  test-hotfix:
    runs-on: ubuntu-latest
    needs: [check-hotfix-branch, validate-hotfix]
    if: needs.check-hotfix-branch.result == 'success' && needs.check-hotfix-branch.outputs.is-hotfix == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      uses: ./.github/actions/install-dependencies
    
    - name: Create .env file
      run: |
        cat > .env << EOF
        LINEAR_WEBHOOK_SECRET=test
        WEBHOOK_PORT=3000
        WORKSPACE_BASE_DIR=./tmp/workspaces
        PROMPT_TEMPLATE_PATH=./examples/prompt-template.txt
        ANTHROPIC_API_KEY=test
        EOF
    
    - name: Run Biome
      run: pnpm biome ci
    
    - name: Build packages
      run: pnpm build
    
    - name: Run tests
      run: pnpm -r test:run
    
    - name: Run additional hotfix validation
      run: |
        echo "ðŸ” Running hotfix-specific validations"
        echo "Checking for critical fixes..."
        
        # Add any hotfix-specific tests here
        # Example: check if the fix addresses the specific issue
        # Example: run regression tests
        
        echo "âœ… Hotfix validation completed"

  # Auto-merge hotfix to multiple branches
  deploy-hotfix:
    runs-on: ubuntu-latest
    needs: [check-hotfix-branch, validate-hotfix, test-hotfix]
    if: needs.check-hotfix-branch.result == 'success' && needs.check-hotfix-branch.outputs.is-hotfix == 'true' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
    
    - name: Create hotfix PR to stage
      run: |
        BRANCH_NAME="${{ github.ref_name }}"
        echo "Creating PR from $BRANCH_NAME to stage"
        
        # Check if PR already exists
        EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base stage --json number --jq '.[0].number' || echo "")
        
        if [[ -z "$EXISTING_PR" ]]; then
          gh pr create \
            --title "ðŸš¨ Hotfix: ${BRANCH_NAME#hotfix/}" \
            --body "## Hotfix Deployment
        
        This is an automated hotfix deployment.
        
        ### Changes
        - Branch: $BRANCH_NAME
        - Commit: ${{ github.sha }}
        - Author: ${{ github.actor }}
        
        ### Deployment Path
        1. $BRANCH_NAME â†’ stage (this PR)
        2. stage â†’ prod (after validation)
        
        ### Review Checklist
        - [ ] Hotfix addresses the critical issue
        - [ ] No unintended side effects
        - [ ] Ready for immediate production deployment
        
        **âš ï¸ This is a hotfix - expedited review required!**" \
            --base stage \
            --head "$BRANCH_NAME" \
            --label hotfix,urgent
          
          echo "âœ… Created hotfix PR to stage"
        else
          echo "â„¹ï¸ PR already exists: #$EXISTING_PR"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Hotfix deployment notification
  notify-hotfix-deployment:
    runs-on: ubuntu-latest
    needs: [check-hotfix-branch, deploy-hotfix]
    if: always() && needs.check-hotfix-branch.result == 'success' && needs.check-hotfix-branch.outputs.is-hotfix == 'true'
    
    steps:
    - name: Notify team
      run: |
        BRANCH_NAME="${{ github.ref_name }}"
        echo "ðŸš¨ HOTFIX DEPLOYMENT ALERT"
        echo "Branch: $BRANCH_NAME"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Status: ${{ needs.deploy-hotfix.result }}"
        
        # Add notification logic here (Slack, email, etc.)
        # Example: Send to Slack webhook
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ðŸš¨ Hotfix deployed: '$BRANCH_NAME'"}' \
        #   $SLACK_WEBHOOK_URL

  # Clean up merged hotfix branches
  cleanup-hotfix:
    runs-on: ubuntu-latest
    needs: check-hotfix-branch
    if: github.event.pull_request.merged == true && needs.check-hotfix-branch.result == 'success' && needs.check-hotfix-branch.outputs.is-hotfix == 'true'
    
    steps:
    - name: Delete hotfix branch
      run: |
        BRANCH_NAME="${{ github.head_ref }}"
        echo "ðŸ§¹ Cleaning up merged hotfix branch: $BRANCH_NAME"
        
        # Delete the hotfix branch after successful merge
        git push origin --delete "$BRANCH_NAME" || echo "Branch may already be deleted"
        
        echo "âœ… Hotfix branch cleanup completed"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}